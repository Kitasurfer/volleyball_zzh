# üìö –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —á–∞—Ç–±–æ—Ç–∞

## –û–±–∑–æ—Ä

–ß–∞—Ç–±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç RAG (Retrieval-Augmented Generation) –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:
1. **–ó–∞–≥—Ä—É–∑–∫–∞** ‚Üí —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
2. **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è** ‚Üí —Ç–µ–∫—Å—Ç —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —á–∞–Ω–∫–∏ –∏ –≤–µ–∫—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è
3. **–ü–æ–∏—Å–∫** ‚Üí –ø—Ä–∏ –≤–æ–ø—Ä–æ—Å–µ –∏—â—É—Ç—Å—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞–Ω–∫–∏
4. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è** ‚Üí LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

---

## –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### Supabase Storage

| Bucket | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|------------|
| `documents` | PDF, DOCX, PPTX —Ñ–∞–π–ª—ã –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π |
| `media-public` | –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ –∏ –¥—Ä—É–≥–∏–µ –º–µ–¥–∏–∞ |

### Supabase Postgres

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------|
| `content_items` | –î–æ–∫—É–º–µ–Ω—Ç—ã –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (title, body_markdown, language, status) |
| `media_assets` | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ |
| `content_media_links` | –°–≤—è–∑—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –º–µ–¥–∏–∞ |
| `vector_jobs` | –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –Ω–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é |
| `chat_sessions` | –°–µ—Å—Å–∏–∏ —á–∞—Ç–∞ |
| `chat_messages` | –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π |

### Qdrant (–≤–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–î)

| –ö–æ–ª–ª–µ–∫—Ü–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------------|
| `content_vectors` | –í–µ–∫—Ç–æ—Ä—ã —á–∞–Ω–∫–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ |

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ—á–∫–∏ –≤ Qdrant:**
```json
{
  "id": "uuid",
  "vector": [1536 floats],
  "payload": {
    "content_id": "uuid",
    "chunk_index": 0,
    "language": "de",
    "title": "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞",
    "url": "/slug",
    "snippet": "–¢–µ–∫—Å—Ç —á–∞–Ω–∫–∞ (–¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)...",
    "headings": ["–†–∞–∑–¥–µ–ª 1", "–ü–æ–¥—Ä–∞–∑–¥–µ–ª"],
    "media": [...],
    "type": "article",
    "source_file": "uploads/file.pdf"
  }
}
```

---

## Edge Functions

### `process-document`
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ PDF/DOCX —Ñ–∞–π–ª—ã:
1. –°–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª –∏–∑ Storage
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç (—á–µ—Ä–µ–∑ Docling –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é)
3. –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ `content_items`
4. –°–æ–∑–¥–∞—ë—Ç `vector_job` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`

### `ingest-content`
–ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –≤ Qdrant:
1. –ë–µ—Ä—ë—Ç pending jobs –∏–∑ `vector_jobs`
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑ `content_items`
3. –†–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ —á–∞–Ω–∫–∏ (1000 —Å–∏–º–≤–æ–ª–æ–≤ —Å overlap 200)
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç embeddings —á–µ—Ä–µ–∑ **OpenAI** (`text-embedding-3-small`)
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Qdrant
6. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å job'–∞

### `chatbot`
–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã:
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç embedding –≤–æ–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ **OpenAI**
2. –ò—â–µ—Ç –≤ Qdrant (top 6, score >= 0.25)
3. –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ **Cerebras** (`qwen-3-235b-a22b-thinking-2507`)
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç + citations

---

## –í–∞–∂–Ω–æ: –ï–¥–∏–Ω–∞—è –º–æ–¥–µ–ª—å embeddings

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω—É –∏ —Ç—É –∂–µ –º–æ–¥–µ–ª—å –¥–ª—è:
- –ò–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ (`ingest-content`)
- –ü–æ–∏—Å–∫–∞ (`chatbot`)

–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- **Embeddings**: OpenAI `text-embedding-3-small` (1536 dimensions)
- **Chat**: Cerebras `qwen-3-235b-a22b-thinking-2507`

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Supabase Secrets)

```bash
# OpenAI (–¥–ª—è embeddings)
OPENAI_API_KEY=sk-...
OPENAI_EMBED_MODEL=text-embedding-3-small

# Cerebras (–¥–ª—è chat)
CEREBRAS_API_KEY=csk-...
CEREBRAS_CHAT_MODEL=qwen-3-235b-a22b-thinking-2507

# Qdrant
QDRANT_URL=https://...qdrant.io
QDRANT_API_KEY=...
QDRANT_COLLECTION=content_vectors

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
CHAT_MAX_CONTEXT_DOCS=6
CHAT_MIN_SCORE=0.25
CHAT_MAX_OUTPUT_TOKENS=1200
```

---

## –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç

### –ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
1. –ó–∞–π—Ç–∏ –≤ Admin ‚Üí Content
2. –ù–∞–∂–∞—Ç—å "Upload document"
3. –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª (PDF/DOCX/PPTX)
4. –í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫
5. –ù–∞–∂–∞—Ç—å "Upload"
6. –î–æ–∂–¥–∞—Ç—å—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å—Ç–∞—Ç—É—Å –≤ —Ç–∞–±–ª–∏—Ü–µ)

### –í—Ä—É—á–Ω—É—é
1. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ `content_items`:
   ```sql
   INSERT INTO content_items (title, slug, language, body_markdown, type, status, published_at)
   VALUES ('–ù–∞–∑–≤–∞–Ω–∏–µ', 'slug', 'de', '# –¢–µ–∫—Å—Ç...', 'article', 'published', NOW());
   ```

2. –°–æ–∑–¥–∞—Ç—å job –Ω–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é:
   ```sql
   INSERT INTO vector_jobs (content_id, status)
   VALUES ('uuid-–∫–æ–Ω—Ç–µ–Ω—Ç–∞', 'pending');
   ```

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é:
   ```bash
   curl -X POST "https://PROJECT.supabase.co/functions/v1/ingest-content" \
     -H "Authorization: Bearer ANON_KEY"
   ```

---

## Troubleshooting

### –ß–∞—Ç–±–æ—Ç –≥–æ–≤–æ—Ä–∏—Ç "–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `vector_jobs` ‚Äî –≤—Å–µ –ª–∏ completed?
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Qdrant ‚Äî –µ—Å—Ç—å –ª–∏ —Ç–æ—á–∫–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏?
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ edge-—Ñ—É–Ω–∫—Ü–∏–∏ chatbot

### Job failed
1. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å `error` –≤ `vector_jobs`
2. –ß–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
   - OpenAI API key –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
   - Qdrant –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
   - –ö–æ–Ω—Ç–µ–Ω—Ç –ø—É—Å—Ç–æ–π

### –°–±—Ä–æ—Å–∏—Ç—å failed job
```sql
UPDATE vector_jobs 
SET status = 'pending', error = NULL, started_at = NULL, completed_at = NULL
WHERE status = 'failed';
```

---

## –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
25 –Ω–æ—è–±—Ä—è 2025
